<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>OathLink è¡Œå‹•æ¸¬è©¦å°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background:#f7f7f7; color:#222; }
    header { padding: 16px; background:#222; color:#fff; }
    h1 { margin:0; font-size: 20px; }
    .muted { font-size: 14px; color:#ccc; }
    main { padding: 16px; }
    section.card { background:#fff; padding:12px; margin-bottom:16px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1);}
    label { font-weight:600; font-size:14px; display:block; margin-top:4px; }
    input,textarea { width:100%; padding:6px; margin-top:2px; font-size:14px; }
    textarea{min-height:60px; resize:vertical;}
    button.btn { margin-right:6px; padding:6px 12px; border:0; border-radius:4px; cursor:pointer; }
    button.accent{background:#0066cc; color:#fff;}
    button.ok{background:#117a36; color:#fff;}
    .row{display:flex;align-items:center;gap:6px;}
    .grid{display:grid;gap:8px;}
    .grid.two{grid-template-columns:1fr 1fr;}
    pre{background:#eee; padding:6px; border-radius:4px; white-space:pre-wrap; word-break:break-word; font-size:13px;}
    .pill{padding:2px 8px; border-radius:12px; font-size:12px;}
  </style>
</head>
<body>
  <header>
    <h1>OathLink è¡Œå‹•æ¸¬è©¦å°</h1>
    <div class="muted">å¯å®‰è£åˆ°ä¸»ç•«é¢çš„ PWAï¼Œæ”¯æ´ /compose èˆ‡è¨˜æ†¶ APIã€‚</div>
  </header>
  <main>
    <!-- é€£ç·šè¨­å®š -->
    <section class="card">
      <div class="grid two">
        <div>
          <label>BASEï¼ˆå¾Œç«¯ç¶²å€ï¼Œå« httpsï¼‰</label>
          <input id="base" placeholder="https://oathlink-backend-clean-production.up.railway.app">
        </div>
        <div>
          <label>X-Auth-Tokenï¼ˆå¦‚å¾Œç«¯æœ‰è¨­ AUTH_TOKENï¼Œå¦å‰‡ç•™ç©ºï¼‰</label>
          <input id="token" placeholder="abc123ï¼ˆå¯ç•™ç©ºï¼‰">
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="btn" id="btnHealth">å¥åº·æª¢æŸ¥ /health</button>
        <button class="btn" id="btnRoot">æ ¹è·¯å¾‘ /</button>
        <span id="status" class="pill">Idle</span>
      </div>
      <pre id="outConn"></pre>
    </section>

    <!-- Compose -->
    <section class="card">
      <h3 style="margin:4px 0 8px;">ğŸ§ª /compose å³æ™‚æ¸¬è©¦</h3>
      <div class="grid">
        <div>
          <label>å•é¡Œ / æŒ‡ä»¤ï¼ˆinputï¼‰</label>
          <textarea id="compInput" placeholder="è«‹æ¢åˆ—ä¸‰é»é€²åº¦ï¼Œä¸¦æ¨™è¨»ä¸‹ä¸€æ­¥"></textarea>
        </div>
        <div class="grid two">
          <div>
            <label>Tagsï¼ˆä»¥é€—è™Ÿåˆ†éš”ï¼Œå¯ç•™ç©ºï¼‰</label>
            <input id="compTags" placeholder="clean,demo">
          </div>
          <div>
            <label>top_k</label>
            <input id="compTopK" type="number" min="1" max="50" value="5">
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="btn accent" id="btnCompose">å‘¼å« /compose</button>
        <button class="btn" id="btnShowPrompt">é¡¯ç¤º promptï¼ˆsystem/userï¼‰</button>
      </div>
      <div class="grid two" style="margin-top:8px;">
        <div>
          <label>å›è¦† output</label>
          <pre id="outCompose"></pre>
        </div>
        <div>
          <label>å‘½ä¸­è¨˜æ†¶ï¼ˆcontext_hitsï¼‰</label>
          <pre id="outHits"></pre>
        </div>
      </div>
      <details style="margin-top:8px;">
        <summary>Raw JSON</summary>
        <pre id="outComposeRaw"></pre>
      </details>
    </section>

    <!-- è¨˜æ†¶å¯«å…¥ï¼æœå°‹ -->
    <section class="card">
      <h3 style="margin:4px 0 8px;">ğŸ§  è¨˜æ†¶ï¼šå¯«å…¥ / æœå°‹</h3>
      <div class="grid two">
        <div>
          <label>âœï¸ content</label>
          <input id="mwContent" placeholder="è¼¸å…¥è¦å¯«å…¥çš„å…§å®¹ï¼Œä¾‹å¦‚ï¼šå®‹æ°¸å‚‘">
          <label style="margin-top:6px;">Tagsï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¯ç•™ç©ºï¼‰</label>
          <input id="mwTags" placeholder="clean,demo">
          <div class="row" style="margin-top:8px;">
            <button class="btn ok" id="btnWrite">POST /memory/write</button>
          </div>
          <pre id="outWrite"></pre>
        </div>
        <div>
          <label>ğŸ” qï¼ˆæœå°‹é—œéµå­—ï¼‰</label>
          <input id="msQ" placeholder="è¼¸å…¥è¦æœå°‹çš„å­—ï¼Œä¾‹å¦‚ï¼šå®‹æ°¸å‚‘">
          <label style="margin-top:6px;">top_k</label>
          <input id="msTopK" type="number" min="1" max="50" value="5">
          <div class="row" style="margin-top:8px;">
            <button class="btn" id="btnSearch">GET /memory/search</button>
          </div>
          <pre id="outSearch"></pre>
        </div>
      </div>
    </section>
  </main>

  <script>
    // â€”â€” SW è¨»å†Šï¼ˆPWAï¼‰
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
      });
    }

    const $ = (id)=>document.getElementById(id);
    const state = {
      get base(){ return $('base').value.trim(); },
      get token(){ return $('token').value.trim(); },
      headers(){
        const h = { 'Content-Type':'application/json; charset=utf-8' };
        if (this.token) h['X-Auth-Token'] = this.token;
        return h;
      }
    };

    function setStatus(txt, ok=true){
      const el = $('status');
      el.textContent = txt;
      el.style.background = ok ? '#18341f' : '#3a1c1c';
      el.style.color = ok ? '#aaf0b9' : '#ffb3b3';
    }
    function j(v){ return JSON.stringify(v, null, 2); }
    function tagsToArr(s){ return (s||'').split(',').map(x=>x.trim()).filter(Boolean); }

    // å¥åº·æª¢æŸ¥
    $('btnHealth').onclick = async ()=>{
      try{
        const r = await fetch(`${state.base}/health`, { headers: state.headers() });
        const data = await r.json();
        $('outConn').textContent = j(data);
        setStatus('OK', true);
      }catch(e){
        $('outConn').textContent = String(e);
        setStatus('ERR', false);
      }
    };
    $('btnRoot').onclick = async ()=>{
      try{
        const r = await fetch(`${state.base}/`, { headers: state.headers() });
        const data = await r.json();
        $('outConn').textContent = j(data);
        setStatus('OK', true);
      }catch(e){
        $('outConn').textContent = String(e);
        setStatus('ERR', false);
      }
    };

    // /compose
    let lastPrompt = null;
    $('btnCompose').onclick = async ()=>{
      const body = {
        input: $('compInput').value.trim(),
        tags: tagsToArr($('compTags').value),
        top_k: parseInt($('compTopK').value||'5',10)
      };
      try{
        const r = await fetch(`${state.base}/compose`, {
          method:'POST', headers: state.headers(), body: JSON.stringify(body)
        });
        const data = await r.json();
        lastPrompt = data.prompt || null;

        $('outCompose').textContent = (data.output || '').trim();
        $('outHits').textContent    = j(data.context_hits||[]);
        $('outComposeRaw').textContent = j(data);
        setStatus(`compose: ${data.ok?'OK':'ERR'}`, !!data.ok);
      }catch(e){
        $('outCompose').textContent = String(e);
        setStatus('ERR', false);
      }
    };
    $('btnShowPrompt').onclick = ()=>{
      if(!lastPrompt){ alert('å°šç„¡ promptï¼Œå¯å…ˆå‘¼å« /compose'); return; }
      const s = [
        'ã€systemã€‘\\n' + (lastPrompt.system || ''),
        'ã€userã€‘\\n'   + (lastPrompt.user || '')
      ].join('\\n\\n');
      const w = window.open('', '_blank');
      w.document.write('<pre style="white-space:pre-wrap;word-break:break-word;">'+
        (s.replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])))+
      '</pre>');
      w.document.close();
    };

    // è¨˜æ†¶ï¼šå¯«å…¥
    $('btnWrite').onclick = async ()=>{
      const body = {
        content: $('mwContent').value.trim(),
        tags: tagsToArr($('mwTags').value)
      };
      try{
        const r = await fetch(`${state.base}/memory/write`, {
          method:'POST', headers: state.headers(), body: JSON.stringify(body)
        });
        const data = await r.json();
        $('outWrite').textContent = j(data);
        setStatus(`write: ${data.ok?'OK':'ERR'}`, !!data.ok);
      }catch(e){
        $('outWrite').textContent = String(e);
        setStatus('ERR', false);
      }
    };

    // è¨˜æ†¶ï¼šæœå°‹
    $('btnSearch').onclick = async ()=>{
      const q = encodeURIComponent(($('msQ').value||'').trim());
      const top_k = parseInt($('msTopK').value||'5',10);
      try{
        const url = `${state.base}/memory/search?q=${q}&top_k=${top_k}`;
        const r   = await fetch(url, { headers: state.headers() });
        const data= await r.json();
        $('outSearch').textContent = j(data);
        setStatus(`search: ${data.ok ? 'OK' : 'ERR'}`, !!data.ok);
      }catch(e){
        $('outSearch').textContent = String(e);
        setStatus('ERR', false);
      }
    };
  </script>
</body>
</html>